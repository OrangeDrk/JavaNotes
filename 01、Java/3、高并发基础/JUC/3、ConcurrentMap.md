[TOC]



# ConcurrentMap - å¹¶å‘æ˜ å°„

## æ¦‚è¿°

1. è¯¥æ˜ å°„æ˜¯JDK1.5 æä¾›çš„ç”¨äºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ˜ å°„æ¥å£
2. è¯¥æ˜ å°„çš„å®ç°ç±»å¾€å¾€æ˜¯å¼‚æ­¥å¼çº¿ç¨‹å®‰å…¨çš„



# ConcurrentHashMap

## ç‰¹å¾

> å¹¶å‘å“ˆå¸Œæ˜ å°„

- è¯¥æ˜ å°„æ˜¯ä¸€ä¸ªå¼‚æ­¥å¼çº¿ç¨‹å®‰å…¨çš„æ˜ å°„
- åº•å±‚æ˜¯ä¾é æ•°ç»„+é“¾è¡¨ç»“æ„æ¥å­˜å‚¨æ•°æ®ï¼›é»˜è®¤å®¹é‡æ˜¯16ï¼Œé»˜è®¤åŠ è½½å› å­æ˜¯0.75
- ä½¿ç”¨æ—¶å¯ä»¥æŒ‡å®šå®¹é‡ï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®š
  - å¦‚æœæŒ‡å®šå®¹é‡nï¼Œå¦‚æœå®¹é‡ä»‹äº2^n^å’Œ2^n-1^ä¹‹é—´ï¼Œå®é™…å®¹é‡ç»è¿‡è¿ç®—åº”è¯¥æ˜¯2^n+1^
  - ä¸æŒ‡å®šå®¹ï¼ŒæŒ‰é»˜è®¤å®¹é‡åˆå§‹åŒ–
- å·²ä½¿ç”¨æ¡¶æ•°/æ€»æ¡¶æ•° > åŠ è½½å› å­(0.75)ï¼Œå°±ä¼šæ‰©å®¹
  - æ¯æ¬¡æ‰©å®¹ï¼Œéƒ½æ˜¯åœ¨åŸæœ‰åŸºç¡€ä¸Šå¢åŠ ä¸€å€
- æ·»åŠ å…ƒç´ 
  - JDK 1.8ä¹‹å‰ï¼šå‘æ¡¶ä¸­çš„é“¾è¡¨æ·»åŠ å…ƒç´ é‡‡ç”¨å¤´æ’æ³•
  - JDK 1.8ä¹‹åï¼šå‘æ¡¶ä¸­çš„é“¾è¡¨æ·»åŠ å…ƒç´ é‡‡ç”¨å°¾æ’æ³•
- å®ç°
  - JDK 1.7ï¼šåº•å±‚é‡‡ç”¨åˆ†æ®µé”+è¯»å†™é”
  - JDK 1.8ï¼šåº•å±‚é‡‡ç”¨æ— é”ç®—æ³•CAS+çº¢é»‘æ ‘

## JDK 1.7åŒºåˆ«

### åˆ†æ®µé”æœºåˆ¶

ConcurrentHashMapæ˜¯ç”±Segmentæ•°ç»„ç»“æ„å’ŒHashEntryæ•°ç»„ç»“æ„ç»„æˆã€‚

- Segmentæ˜¯ä¸€ç§å¯é‡å…¥é”ReentrantLockï¼Œåœ¨ConcurrentHashMapé‡Œæ‰®æ¼”é”çš„è§’è‰²
- HashEntryåˆ™ç”¨äºå­˜å‚¨é”®å€¼å¯¹æ•°æ®ã€‚

ä¸€ä¸ªConcurrentHashMapé‡ŒåŒ…å«

- ä¸€ä¸ªSegmentæ•°ç»„ï¼ŒSegmentçš„ç»“æ„å’ŒHashMapç±»ä¼¼ï¼Œæ˜¯ä¸€ç§æ•°ç»„å’Œé“¾è¡¨ç»“æ„
- ä¸€ä¸ªSegmenté‡ŒåŒ…å«ä¸€ä¸ªHashEntryæ•°ç»„ï¼Œæ¯ä¸ªHashEntryæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„çš„å…ƒç´ ï¼Œ æ¯ä¸ªSegmentå®ˆæŠ¤è€…ä¸€ä¸ªHashEntryæ•°ç»„é‡Œçš„å…ƒç´ ,å½“å¯¹HashEntryæ•°ç»„çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¿…é¡»é¦–å…ˆè·å¾—å®ƒå¯¹åº”çš„Segmenté”ã€‚

![](https://gitee.com/sxhDrk/images/raw/master/imgs/20210427111215.png)

![](https://gitee.com/sxhDrk/images/raw/master/imgs/20210427111216.png)



### è¯»å†™é”

> åœ¨JDK 1.7 ä¸­ï¼ŒConcurrentHashMapåœ¨åˆ†æ®µé”çš„åŸºç¡€ä¸Šå¼•å…¥äº†è¯»å†™é”ï¼Œæé«˜äº†ConcurrentHashMapçš„æ•ˆç‡

- è¯»é”ï¼šåªè¯»æ•°æ®ï¼Œå¯ä»¥å¾ˆå¤šçº¿ç¨‹åŒæ—¶è¯»ï¼Œä½†ä¸èƒ½å†™ï¼Œå°±åŠ è¯»é”
- å†™é”ï¼šå†™æ•°æ®ï¼Œåªèƒ½æœ‰ä¸€ä¸ªäººå†™æ•°æ®ï¼Œä¸”ä¸èƒ½è¯»å–ï¼Œå°±åŠ å†™é”



## JDK 1.8åŒºåˆ«

### CAS

> è€ƒè™‘é”å¸¦æ¥çš„å¼€é”€ï¼ˆé”åœ¨CPUä¸Šå®é™…ä¸Šä¼šéå¸¸å ç”¨èµ„æºï¼‰ï¼Œå¼•å…¥äº†ä¸€å¥—æ— é”ç®—æ³•CAS(Compare And Swap - æ¯”è¾ƒå’Œäº¤æ¢)
>
> CASè™½ç„¶å«ç®—æ³•ï¼Œä½†å®é™…ä¸Šæ˜¯ç»“åˆç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…æ ¸æ¶æ„æ¥å®ç°çš„

CASè¯­ä¹‰ï¼šæˆ‘è®¤ä¸ºVçš„å€¼åº”è¯¥æ˜¯Aï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå°†Vçš„å€¼æ›´æ–°ä¸ºBï¼Œå¦åˆ™ä¸ä¿®æ”¹å¹¶å‘Šè¯‰Vçš„å€¼å®é™…ä¸ºå¤šå°‘

- Vï¼šå†…å­˜å€¼
- Aï¼šæ—§çš„é¢„æœŸå€¼
- Bï¼šæ–°çš„é¢„æœŸå€¼

![](../img/JUC/CAS.png)

> CASç‰¹ç‚¹ï¼š

- CASçš„æœ¬æ„ä¸ºCompare And Swapï¼Œæ˜¯ä¸€ç§æ— é”ç®—æ³•
- CASéœ€è¦ç»“åˆCPUæŒ‡ä»¤å®ç°ï¼Œç°åœ¨å¤§å¤šæ•°å¤„ç†å™¨æ¶æ„éƒ½æ”¯æŒCASç®—æ³•çš„
- CASæ˜¯ä¸€ç§ä¹è§‚é”ï¼Œå³å½“å¤šä¸ªçº¿ç¨‹å°è¯•ä½¿ç”¨CASåŒæ—¶æ›´æ–°ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œåªæœ‰å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹èƒ½æ›´æ–°å˜é‡çš„å€¼ï¼Œè€Œå…¶ä»–çº¿ç¨‹å¤±è´¥ã€‚å¤±è´¥çš„çº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œè€Œæ˜¯ä¼šè¢«å‘ŠçŸ¥åœ¨æœ¬æ¬¡ç«äº‰ä¸­å¤±è´¥ï¼Œå¹¶ä¸”å¯ä»¥å†æ¬¡å°è¯•
- CASæœ‰ä¸‰ä¸ªå‚æ•°ï¼šå†…å­˜å€¼Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹æˆçš„å€¼B
- å½“ä¸”ä»…å½“é¢„æœŸå€¼Aå’Œå†…å­˜å€¼Vå¯¹åº”çš„å€¼ç›¸åŒï¼Œæ‰ä¼šå°†å€¼ä¿®æ”¹ä¸ºBï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åš





### é“¾è¡¨è½¬çº¢é»‘æ ‘

> JDK 1.8 å¼€å§‹ï¼Œå¼•å…¥çº¢é»‘æ ‘æœºåˆ¶

==å½“æ•°ç»„é•¿åº¦>=64æ—¶ï¼Œå¦‚æœæ¡¶ä¸­çš„å…ƒç´ è¶…è¿‡8ä¸ªçš„æ—¶å€™==ï¼Œä¼šå°†è¿™ä¸ªæ¡¶ä¸­çš„é“¾è¡¨æ‰­è½¬æˆä¸€ä¸ªçº¢é»‘æ ‘

å¦‚æœè¿™ä¸ªæ¡¶ä¸­çº¢é»‘æ ‘çš„èŠ‚ç‚¹<=7ä¸ªï¼Œä¼šå°†è¿™é¢—çº¢é»‘æ ‘æ‰­è½¬å›é“¾è¡¨

![](../img/JUC/ConcurrentHashMapå¼•å…¥çº¢é»‘æ ‘.png)



## çº¢é»‘æ ‘

> ==è¯¦ç»†çº¢é»‘æ ‘æŸ¥çœ‹æ•°æ®ç»“æ„ç›®å½•==

- çº¢é»‘æ ‘æœ¬èº«æ˜¯ä¸€é¢—è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘
- äºŒå‰æŸ¥æ‰¾æ ‘çš„ç‰¹ç‚¹ï¼šå·¦å­æ ‘å°äºæ ¹ï¼Œå³å­æ ‘å¤§äºæ ¹
- çº¢é»‘æ ‘ç‰¹ç‚¹ï¼š
  - æ‰€æœ‰èŠ‚ç‚¹éçº¢å³é»‘
  - æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²
  - çº¢èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸€å®šæ˜¯é»‘è‰²çš„ï¼›é»‘èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å¯çº¢å¯é»‘
  - ä»æ ¹èŠ‚ç‚¹åˆ°ä»»æ„ä¸€ä¸ªå¶å­èŠ‚ç‚¹çš„è·¯å¾„ä¸­åŒ…å«çš„é»‘è‰²èŠ‚ç‚¹ä¸ªæ•°ç›¸åŒã€‚å³é»‘èŠ‚ç‚¹çš„é«˜åº¦æ˜¯ä¸€è‡´çš„
  - æ–°å¢èŠ‚ç‚¹ä¸€å®šæ˜¯çº¢è‰²

### ä¿®æ­£æ“ä½œ

> å½“æ·»åŠ ä¹‹åï¼šçˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²

1. æ¶‚è‰²ï¼šå”çˆ¶èŠ‚ç‚¹ä¸ºçº¢ï¼šå°†çˆ¶èŠ‚ç‚¹ä»¥åŠå”çˆ¶èŠ‚ç‚¹æ¶‚é»‘ï¼Œç„¶åå°†ç¥–çˆ¶èŠ‚ç‚¹æ¶‚çº¢
2. å·¦æ—‹ï¼šå”çˆ¶èŠ‚ç‚¹ä¸ºé»‘ï¼Œå¹¶ä¸”å½“å‰å­èŠ‚ç‚¹æ˜¯å³èŠ‚ç‚¹ï¼Œéœ€è¦ä»¥å½“å‰èŠ‚ç‚¹ä¸ºè½´è¿›è¡Œå·¦æ—‹
3. å³æ—‹ï¼šå”çˆ¶èŠ‚ç‚¹ä¸ºé»‘ï¼Œå¹¶ä¸”å½“å‰å­èŠ‚ç‚¹æ˜¯å·¦èŠ‚ç‚¹ï¼Œéœ€è¦ä»¥çˆ¶èŠ‚ç‚¹ä¸ºè½´å³æ—‹



> ä¿®æ­£æ¡ˆä¾‹

![](../img/JUC/çº¢é»‘æ ‘ä¿®æ­£.png)





# ConcurrentNavigableMap

> å¹¶å‘å¯¼èˆªæ˜ å°„

- ConcurrentNavigableMapä¸­æä¾›äº†ç”¨äº==æˆªå–å­æ˜ å°„çš„æ–¹æ³•==
- ConcurrentNavigableMapæœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç›®å‰ä¸ºæ­¢åªæä¾›äº†ä¸€ä¸ªå®ç°ç±»`ConcurrentSkipListMap`
- `ConcurrentSkipListMap` ï¼šå¹¶å‘è·³è·ƒè¡¨æ˜ å°„ï¼Œåº•å±‚æ˜¯åŸºäºè·³è·ƒè¡¨æ¥å­˜å‚¨çš„

## ConcurrentSkipListMap

### ä»£ç 

```java
public class ConcurrentNavigableMaoDemo {

    public static void main(String[] args) {
        ConcurrentNavigableMap<String, Integer> map = new ConcurrentSkipListMap<>();

        map.put("a",3);
        map.put("r",4);
        map.put("y",5);
        map.put("b",6);
        map.put("f",7);
        map.put("q",8);
        map.put("o",1);

        //è¾“å‡ºæ•´ä¸ªmap
        System.out.println(map);

        //ä»å¤´éƒ¨æˆªå–åˆ°"o"ä½ç½®ï¼Œä¸åŒ…æ‹¬"o"
        System.out.println(map.headMap("o"));

        //ä»"o"å¼€å§‹æˆªå–åˆ°å°¾éƒ¨,åŒ…æ‹¬"o"
        System.out.println(map.tailMap("o"));

        //æˆªå–["b","r")
        System.out.println(map.subMap("b","r"));
    }
}

//ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ç»“æœğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡
{a=3, b=6, f=7, o=1, q=8, r=4, y=5}
{a=3, b=6, f=7}
{o=1, q=8, r=4, y=5}
{b=6, f=7, o=1, q=8}
```



### è·³è·ƒè¡¨

- è·³è·ƒè¡¨é’ˆå¯¹çš„æœ‰åºå…ƒç´ 
- è·³è·ƒè¡¨é€‚åˆæŸ¥è¯¢å¤šè€Œå¢åˆ å°‘çš„åœºæ™¯
- è·³è·ƒè¡¨å¯ä»¥å±‚å±‚æå–ï¼Œå½¢æˆå¤šå±‚çš„è·³è·ƒè¡¨ï¼Œæœ€ä¸Šå±‚è·³è·ƒè¡¨çš„å…ƒç´ ä¸ªæ•°ä¸å°‘äº2ä¸ª
- è·³è·ƒè¡¨æœ¬èº«æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œä»¥ç©ºé—´æ¢æ—¶é—´â€çš„äº§ç‰©
- å¦‚æœåœ¨è·³è·ƒè¡¨ä¸­æ–°å¢å…ƒç´ ï¼Œé‚£ä¹ˆæ–°å¢çš„å…ƒç´ æ˜¯å¦è¦æå–åˆ°ä¸Šå±‚è·³è·ƒè¡¨ä¸­ï¼Œéµå¾ªâ€œæŠ›ç¡¬å¸â€åŸåˆ™
- è·³è·ƒè¡¨çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æ˜¯O(lgn)

![](https://gitee.com/sxhDrk/images/raw/master/imgs/20210427111220.png)